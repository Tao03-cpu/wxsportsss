<!-- 页面：部落聊天（tribeChat） -->
<view class="chat-container">
  <scroll-view class="message-list" scroll-y scroll-into-view="{{scrollTarget}}" scroll-with-animation>
    <block wx:for="{{messages}}" wx:key="_id">
      <view id="msg-{{item._id}}" class="message-item {{item.sender_id === openid ? 'self' : 'other'}}">
        <!-- 点击头像触发 @ -->
        <!-- 修复：简化逻辑，只判断是否有值且不含失效关键词，否则用默认图 -->
        <image class="avatar"
               src="{{avatarMap[item.sender_id] || (item.sender_avatar && item.sender_avatar.length > 5 && item.sender_avatar.indexOf('default avatar.jpg') === -1 ? item.sender_avatar : '/assets/tips-icon.png')}}"
               bindtap="onAvatarTap"
               data-url="{{avatarMap[item.sender_id] || (item.sender_avatar && item.sender_avatar.length > 5 && item.sender_avatar.indexOf('default avatar.jpg') === -1 ? item.sender_avatar : '/assets/tips-icon.png')}}"
               data-name="{{nameMap[item.sender_id] || item.sender_name}}"
               data-bot="{{item.sender_id === 'AI_BOT'}}"></image>
        <view>
          <view class="nickname" wx:if="{{item.sender_id !== openid}}">{{nameMap[item.sender_id] || item.sender_name}}</view>
          <view class="content">{{item.content}}</view>
        </view>
      </view>
    </block>
    <view id="bottom-anchor" style="height: 20rpx;"></view>
  </scroll-view>

  <!-- 修复：z-index 提高到 999 确保点击，去掉 transition 防止跳动干扰 -->
  <view class="input-area" style="bottom: {{keyboardHeight}}px; z-index: 999;">
    <input class="input" value="{{inputText}}" bindinput="onInput" confirm-type="send" bindconfirm="sendMessage" placeholder="发消息..." adjust-position="{{false}}" bindfocus="onFocus" bindblur="onBlur" focus="{{inputFocus}}" />
    <!-- 修复：明确的 bindtap 绑定 -->
    <view class="send-btn {{!inputText.trim() ? 'disabled' : ''}}" bindtap="sendMessage">发送</view>
  </view>
</view>
